
<form id="requestForm">
  <label for="employeeId">Employee ID</label>
  <input id="employeeId" name="employeeId" type="text" required />

  <label for="requestNumber">Request Number</label>
  <input id="requestNumber" name="requestNumber" type="text" required />

  <label for="attachment">Attachment</label>
  <input id="attachment" name="attachment" type="file" required />

  <button type="submit">Submit</button>
</form>

<pre id="status" class="status" aria-live="polite" style="white-space: pre-wrap;"></pre>
<!--- begin 
<script>
  async function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const [, base64] = reader.result.split(',');
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('requestForm');
    const responseEl = document.getElementById('status');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const employeeId = document.getElementById('employeeId').value.trim();
      const requestNumber = document.getElementById('requestNumber').value.trim();
      const fileInput = document.getElementById('attachment');

      if (!employeeId || !requestNumber || !fileInput.files.length) {
        responseEl.className = 'error';
        responseEl.textContent = 'Please fill all fields and attach a file.';
        return;
      }

      const file = fileInput.files[0];
      if (file.size > 5 * 1024 * 1024) {
        responseEl.className = 'error';
        responseEl.textContent = 'File too large (max 5 MB).';
        return;
      }

      const fileBase64 = await fileToBase64(file);
      const payload = {
        EmployeeID: employeeId,
        RequestNumber: requestNumber,
        filename: 'Default',
        fileBase64
      };

      responseEl.className = '';
      responseEl.textContent = 'Submitting...';

      try {
        const res = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));
        responseEl.className = res.ok ? 'success' : 'error';
        responseEl.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        responseEl.className = 'error';
        responseEl.textContent = `Network error: ${err.message}`;
      }
    });
  });
</script>
--->

<script>
  async function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const [, base64] = reader.result.split(',');
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('requestForm');
    const responseEl = document.getElementById('status');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const employeeId = document.getElementById('employeeId').value.trim();
      const requestNumber = document.getElementById('requestNumber').value.trim();
      const fileInput = document.getElementById('attachment');

      console.log('[Submit] Started');
      if (!employeeId || !requestNumber || !fileInput.files.length) {
        responseEl.className = 'error';
        responseEl.textContent = 'Please fill all fields and attach a file.';
        console.warn('[Submit] Missing fields or file');
        return;
      }

      const file = fileInput.files[0];
      console.log('[File] name=%s size=%d type=%s', file.name, file.size, file.type);

      if (file.size > 5 * 1024 * 1024) {
        responseEl.className = 'error';
        responseEl.textContent = 'File too large (max 5 MB).';
        console.warn('[File] Too large');
        return;
      }

      let fileBase64;
      try {
        fileBase64 = await fileToBase64(file);
        console.log('[File] Base64 length =', fileBase64.length);
      } catch (err) {
        responseEl.className = 'error';
        responseEl.textContent = 'Could not read file.';
        console.error('[File] Read error:', err);
        return;
      }

      const payload = {
        EmployeeID: employeeId,
        RequestNumber: requestNumber,
        filename: 'Default',
        fileBase64
      };
      console.log('[Payload]', payload);

      responseEl.className = '';
      responseEl.textContent = 'Submitting...';

      try {
        const res = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        console.log('[Response] status=%d ok=%s', res.status, res.ok);
        const ct = res.headers.get('content-type') || '';
        console.log('[Response] content-type:', ct);

        let data;
        if (ct.includes('application/json')) {
          data = await res.json();
          console.log('[Response] JSON:', data);
        } else {
          // Fallback for non-JSON responses
          const text = await res.text();
          console.log('[Response] Text:', text);
          // Try to display text; if it looks like JSON, format it
          try { data = JSON.parse(text); } catch { data = { raw: text }; }
        }

        responseEl.className = res.ok ? 'success' : 'error';
        responseEl.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        responseEl.className = 'error';
        responseEl.textContent = `Network error: ${err.message}`;
        console.error('[Fetch] Error:', err);
      }
    });
  });
</script>

<style>
  .success { color: #0a7; }
  .error   { color: #c00; }
</style>
